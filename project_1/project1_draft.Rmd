---
title: "Project 1 - Draft"
author: "Ji-Eun Park"
date: "9/18/2019"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
# options("max.print" = 1000)
```

### 1. Load the dataset

```{r}
path <- paste0(getwd(),"/data/")
dat <- as.data.frame(data.table::fread(file=paste0(path,"UMD_Services_Provided_20190719.tsv"), col.names = c("Date", "ClientFileNum", "ClientFileMerge", "BusTicketCount", "Note", "FoodProvided",
                                                     "Food_lbs", "Clothing", "Diapers", "SchoolKit", "HygieneKit", "Referrals", "FinSupport",
                                                     "TypeOfBillPaid", "PayerOfSupport", "F1", "F2", "F3")))
```

### 2. Data wrangling

#### (1) `Date`

```{r}
dat$Date <- as.Date(dat$Date, format = "%m/%d/%Y") 
# dat$Date[dat$Date > Sys.Date()] # There are 7 dates which are in the future. It seems that they are typos.

base.date <- as.Date("1983-01-01", format="%Y-%m-%d")

# filter out abnormal dates 
## 1. earlier than the foundation year (01-01-1983)
## 2. later than current(09-25-2019)
dat <- dat %>%
  filter(Date <= Sys.Date(), Date >= base.date)
```

#### (2) `ClientFileNum` and `ClientFileMerge`

```{r}
dat <- dat %>%
  select(-ClientFileMerge)
```

- Remove `ClientFileMerge` column

**Our data contains a great amount of NA's. For the variables below, I will be imputating with zero's, since we can assume that NA may stand for not provided.**

#### (3) `BusTicketCount`

```{r}
dat$BusTicketCount[is.na(dat$BusTicketCount)] <- 0 # Replace NAs with 0 in BusTicketCount column
```

#### (4) `Note`

```{r}
dat <- dat %>%
  select(-Note)
# unique(dat$Note) # Too many to categorize
```

- Remove `Note` column

#### (5) `FoodProvided`

```{r}
dat$FoodProvided[is.na(dat$FoodProvided)] <- 0 # Replace NAs with 0 in FoodProvided column

# (sum(dat$FoodProvided == 0) / length(dat$FoodProvided) * 100) %>% round(2) # 29.34% are 0s.
```


#### (6) `Food_lbs`

```{r}
dat$Food_lbs[is.na(dat$Food_lbs)] <- 0 # Replace NAs with 0 in Food_lbs column

# (sum(dat$Food_lbs == 0) / length(dat$Food_lbs) * 100) %>% round(2) # 38.23% are 0s.
```

#### (7) `Clothing`

```{r}
dat$Clothing[is.na(dat$Clothing)] <- 0 # Replace NAs with 0 in Clothing column

# (sum(dat$Clothing == 0) / length(dat$Clothing) * 100) %>% round(2) # 16.92% are 0s.
```

#### (8) `Diapers`

```{r}
dat$Diapers[is.na(dat$Diapers)] <- 0 # Replace NAs with 0 in Diapers column

# (sum(dat$Diapers == 0) / length(dat$Diapers) * 100) %>% round(2) # 98.89% are 0s.
```


#### (9) `SchoolKit`

```{r}
dat$SchoolKit[is.na(dat$SchoolKit)] <- 0 # Replace NAs with 0 in SchoolKit column

# (sum(dat$SchoolKit == 0) / length(dat$SchoolKit) * 100) %>% round(2) # 99.96% are 0s.
```

#### (10) `HygieneKit`

```{r}
dat$HygieneKit[is.na(dat$HygieneKit)] <- 0 # Replace NAs with 0 in HygieneKit column

# (sum(dat$HygieneKit == 0) / length(dat$HygieneKit) * 100) %>% round(2) # 96.18% are 0s.
```

#### (11) `Referrals`

```{r}
dat <- dat %>%
  select(-Referrals)
```

- Remove `Referrals` column

#### (12) `FinSupport`

```{r}
dat$FinSupport[is.na(dat$FinSupport)] <- 0  # Replace NAs with 0 in FinSupport column
```

#### (13) `TypeOfBillPaid`, `PayerOfSupport`

```{r}
# unique(dat$TypeOfBillPaid) # Too many to categorize
dat <- dat %>%
  select(-c(TypeOfBillPaid,PayerOfSupport))
```

- Remove `TypeOfBillPaid` and `PayerOfSupport` columns

#### (14) Remove F1,F2,F3
```{r}
dat <- dat %>%
  select(-c(F1,F2,F3))
```

#### Generate categorical year column
```{r}
# Generate a column with only the year of the visit date
dat$Year <- format(as.Date(dat$Date, format="%d/%m/%Y"),"%Y")
range(dat$Year)
# Generate a categorical date column from 1 to 10. 1 is the earliest, 2 is the most recent.
dat$Date.cat <- ifelse(dat$Year < format(as.Date("2000", format="%Y"), "%Y"), "1990s", ifelse(dat$Year < format(as.Date("2010", format="%Y"), "%Y"), "2000s", "2010s"))
```

### 3. Exploratory Data Analysis
#### Number of Visits
```{r fig.width=6}
# Plot the number of visits in each year
ggplot(dat, aes(Year, group=Year)) +
  geom_bar(fill="lightgreen") +
  theme_bw() +
  labs(title= "Number of Visits from 1990 to 2019")
```

#### Number of Clients
```{r, fig.width=6}
# Generate a dataset to plot the number of clients in each year (remove clients with multiple visits per year)
dat %>% 
  select(Year, ClientFileNum, Date.cat) %>%
  unique() ->  ead1 

# Plot the number of clients in each year
ggplot(ead1, aes(Year, group=Year)) +
  geom_bar(fill="Lightblue") +
  theme_bw() +
  labs(title= "Number of Clients from 1990 to 2019")
```

#### Visits per Client
```{r, fig.width=6}
dat %>%
  select(Year, ClientFileNum) %>%
  group_by(Year) %>%
  mutate(visits=n()) %>%
  unique() %>%
  group_by(Year) %>%
  mutate(Clients=n()) %>%
  mutate(p=visits/Clients) -> ead2 

ead2 %>%
  select(Year, visits, Clients, p) %>%
  unique() -> ead2

ggplot(ead2, aes(x=Year,y=p)) +
  geom_bar(stat = "identity", fill="orange") +
  theme_bw() +
  labs(title="Visits per Client from 1990 to 2019")
```

#### How many clients visited more than one year?
```{r fig.width=8}
# generate data with the proportion of number of visitors
dat %>%
  group_by(ClientFileNum) %>%
  count(Year) %>%
  group_by(ClientFileNum) %>%
  count() -> ead3

ead3$freq <- ifelse(ead3$n <=3, "le1", ">1")
ead3 %>% group_by(freq) %>% count() -> ead3.1
ead3.1$p <- round(ead3.1$n / sum(ead3.1$n),3)*100

# generate a barplot to make pie chart
bp <- ggplot(ead3.1, aes(x="",y=p, fill=freq))+
  geom_bar(width = 1, stat = "identity") +
  theme_bw() +
  labs(title="Proportion of Number of Visits Years per Client") +
  scale_fill_manual(name = "Number of Visiting Years", labels = c("once ","more than once"),values=c( "#E69F00", "#56B4E9"))

# make a theme to remove the outer box
blank_theme <- theme(
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.border = element_blank(),
  panel.grid=element_blank(),
  axis.ticks = element_blank(),
  plot.title=element_text(size=14, face="bold")
  )

# Geneate into pie chart
pie <- bp + coord_polar("y", start=0) +  theme(axis.text.x=element_blank())

# Add text to indicate the proportion
pie +
  blank_theme +
  geom_text(x=c(1.2,1.3), y=c(-6,10),label=scales::percent(ead3.1$p/100))
```

1. Are there specific service/goods in higher demand recently?
```{r}
dat <- dat[order(dat$Date),] # Order the dataset by time order



```

2. Are there specific trends in higher demand in certain seasons?
3. Are there any trends in young children in need of help?
4. Are there higher demand of support from the organization than before? Should the organization be prepared for more budget in order to support the future demands?


