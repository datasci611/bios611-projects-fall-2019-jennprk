---
title: "Project 1 - Draft"
author: "Ji-Eun Park"
date: "9/18/2019"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = F, fig.width = 6, fig.height = 6, fig.align = "center", warning = F, message = F)
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(lubridate)
library(zoo)
library(BTKR)
library(multcomp)
library(flextable)
# options("max.print" = 1000)
```


### 3. Exploratory Data Analysis
#### Number of Visits
```{r fig.width = 4, fig.align = "center", fig.height = 4}
# Plot the number of visits in each year
ggplot(dat, aes(Year, group=Year)) +
    geom_bar(fill=brewer.pal(3, "Set2")[1]) +
    theme_bw() +
    labs(title = "Number of Visits from 1990 to 2019") +
    theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold"), 
          axis.text.x = element_text(angle = 90))
```

#### Number of Clients
```{r fig.width = 4, fig.align = "center", fig.height = 4}
# Generate a dataset to plot the number of clients in each year (remove clients with multiple visits per year)
dat %>% 
    dplyr::select(Year, ClientFileNum, Date.cat) %>%
    unique() ->  ead1 

# Plot the number of clients in each year
ggplot(ead1, aes(Year, group=Year)) +
    geom_bar(fill=brewer.pal(3, "Set2")[2]) +
    theme_bw() +
    labs(title= "Number of Clients from 1990 to 2019", y = "Count") +
    theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold"), 
          axis.text.x = element_text(angle = 90))
```

#### Visits per Client (Average Number of Visits)
```{r fig.width = 4, fig.align = "center", fig.height = 4}
dat %>%
    dplyr::select(Year, ClientFileNum) %>%
    group_by(Year) %>%
    mutate(visits=n()) %>%
    unique() %>%
    group_by(Year) %>%
    mutate(Clients=n()) %>%
    mutate(p=visits/Clients) -> ead2 

ead2 %>%
    dplyr::select(Year, visits, Clients, p) %>%
    unique() -> ead2

ggplot(ead2, aes(x=Year,y=p)) +
    geom_bar(stat = "identity", fill=brewer.pal(3, "Set2")[3]) +
    theme_bw() +
    labs(title="Visits per Client from 1990 to 2019", y = "Average Number of Visits") +
    theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold"), 
          axis.text.x = element_text(angle = 90))
```

#### How many clients visited more than one year?
```{r}
# generate data with the proportion of number of visitors
dat %>%
  group_by(ClientFileNum) %>%
  count(Year) %>%
  group_by(ClientFileNum) %>%
  count() -> ead3

ead3$freq <- ifelse(ead3$n <=3, "le1", ">1")
ead3 %>% group_by(freq) %>% count() -> ead3.1
ead3.1$p <- round(ead3.1$n / sum(ead3.1$n),3)*100

# generate a barplot to make pie chart
bp <- ggplot(ead3.1, aes(x="",y=p, fill=freq))+
  geom_bar(width = 1, stat = "identity") +
  theme_bw() +
  labs(title="Proportion of Number of Visits Years per Client") +
  scale_fill_manual(name = "Number of Visiting Years", labels = c("once ","more than once"),values=brewer.pal(3, "Set2")[c(2, 1)])

# make a theme to remove the outer box
blank_theme <- theme(
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.border = element_blank(),
  panel.grid=element_blank(),
  axis.ticks = element_blank(),
  plot.title=element_text(size=16, face="bold")
  )

# Geneate into pie chart
pie <- bp + coord_polar("y", start=0) +  theme(axis.text.x=element_blank())

# Add text to indicate the proportion
pie +
  blank_theme +
  geom_text(x=c(1.2,1.3), y=c(-6,10),label=scales::percent(ead3.1$p/100))
```

1. Are there specific service/goods in higher demand recently?

```{r fig.width = 10, fig.height = 16, fig.align="center"}
dat <- dat %>% arrange(Date) # Order the dataset by time order

# This year: number of cases filed
dat %>% filter(lubridate::year(Date) > 2015) %>%
    mutate(YearMonth = strftime(Date, "%Y-%m")) %>%
    group_by(YearMonth) %>%
    summarise(BusTicket = sum(BusTicketCount),
              FoodProvided = sum(FoodProvided),
              Clothing = sum(Clothing),
              Diapers = sum(Diapers),
              SchoolKit = sum(SchoolKit),
              HygieneKit = sum(HygieneKit)) %>%
    reshape2::melt(., by = c("YearMonth")) -> q1
colnames(q1) <- c("YearMonth", "Category", "CaseNum")
q1$YMD <- as.Date(paste0(q1$YearMonth, "-01"))


# 1) BusTicket: all 0 recently (2015-2019)
q1.BT <- q1 %>% filter(Category == "BusTicket")
Year <- factor(year(q1.BT$YMD))
pBT <- ggplot(dat = q1.BT, aes(x = month(YMD, label=TRUE, abbr=TRUE), 
                y = CaseNum, group=Year, fill=Year)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(x="Month", colour="Year") +
    theme_bw() + scale_fill_brewer(palette="Set2") + 
    labs(title = "Bus Ticket", y = "Number of Cases Filed") +
    theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold"))


# 2) FoodProvided
q1.FP <- q1 %>% filter(Category == "FoodProvided")
Year <- factor(year(q1.FP$YMD))
pFP <- ggplot(dat = q1.FP, aes(x = month(YMD, label=TRUE, abbr=TRUE), 
                y = CaseNum, group=Year, fill=Year)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(x="Month", colour="Year") +
    theme_bw() + scale_fill_brewer(palette="Set2") + 
    labs(title = "Food Provided", y = "Number of Cases Filed") +
    theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold"))

# 3) Clothing
q1.CL <- q1 %>% filter(Category == "Clothing")
Year <- factor(year(q1.CL$YMD))
pCL <- ggplot(dat = q1.CL, aes(x = month(YMD, label=TRUE, abbr=TRUE), 
                y = CaseNum, group=Year, fill=Year)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(x="Month", colour="Year") +
    theme_bw() + scale_fill_brewer(palette="Set2") + 
    labs(title = "Clothing", y = "Number of Cases Filed") +
    theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold"))

# 4) Diapers
q1.D <- q1 %>% filter(Category == "Diapers")
Year <- factor(year(q1.D$YMD))
pD <- ggplot(dat = q1.D, aes(x = month(YMD, label=TRUE, abbr=TRUE), 
                y = CaseNum, group=Year, fill=Year)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(x="Month", colour="Year") +
    theme_bw() + scale_fill_brewer(palette="Set2") + 
    labs(title = "Diapers", y = "Number of Cases Filed") +
    theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold"))

# 5) SchoolKit
q1.SK <- q1 %>% filter(Category == "SchoolKit")
Year <- factor(year(q1.SK$YMD))
pSK <- ggplot(dat = q1.SK, aes(x = month(YMD, label=TRUE, abbr=TRUE), 
                y = CaseNum, group=Year, fill=Year)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(x="Month", colour="Year") +
    theme_bw() + scale_fill_brewer(palette="Set2") + 
    labs(title = "School Kit", y = "Number of Cases Filed") +
    theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold"))

# 6) Hygiene Kit
q1.HK <- q1 %>% filter(Category == "HygieneKit")
Year <- factor(year(q1.HK$YMD))
pHK <- ggplot(dat = q1.HK, aes(x = month(YMD, label=TRUE, abbr=TRUE), 
                y = CaseNum, group=Year, fill=Year)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(x="Month", colour="Year") +
    theme_bw() + scale_fill_brewer(palette="Set2") + 
    labs(title = "Hygiene Kit", y = "Number of Cases Filed") +
    theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold"))

gridExtra::grid.arrange(pBT, pFP, pCL, pD, pSK, pHK)
```

2. Are there specific trends in higher demand in certain seasons?
```{r fig.width = 6, fig.height = 8, fig.align = "center"}
dat %>% 
    mutate(YearMonth = strftime(Date, "%Y-%m")) %>%
    group_by(YearMonth) %>%
    summarise(BusTicket = sum(BusTicketCount),
              FoodProvided = sum(FoodProvided),
              Clothing = sum(Clothing),
              Diapers = sum(Diapers),
              SchoolKit = sum(SchoolKit),
              HygieneKit = sum(HygieneKit)) %>%
    reshape2::melt(., by = c("YearMonth")) -> q2
colnames(q2) <- c("YearMonth", "Category", "CaseNum")
q2 <- q2 %>% mutate(YMD = as.Date(paste0(q2$YearMonth, "-01")),
                    Season = ifelse(month(YMD) >= 3 & month(YMD) <= 5, "Spring",
                                    ifelse(month(YMD) >= 6 & month(YMD) <= 8, "Summer", 
                                           ifelse(month(YMD) >= 9 & month(YMD) <= 11, "Fall", "Winter"))))
q2$Season <- factor(q2$Season, level = c("Spring", "Summer", "Fall", "Winter"))

# Define the four seasons by month:
    # - Mar Apr May: Spring
    # - Jun Jul Aug: Summer
    # - Sep Oct Nov: Fall
    # - Dec Jan Feb: Winter

q2.1 <- q2 %>% 
    group_by(Season, Category) %>% 
    summarise(CaseNum = sum(CaseNum)) %>% 
    arrange(Category) %>%
    as.data.frame()

p.q21 <- ggplot(dat = q2.1, aes(x = Season, y = CaseNum, group=Category, colour=Category)) +
    geom_line() +
    geom_point() +
    labs(title = "Trend of Categories by Season", x="Season", y = "Number of Cases Filed", colour="Category") +
    theme_bw() + scale_fill_brewer(palette="Set2") + 
    theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold")) 


p2.q21 <- ggplot(dat = q2.1, aes(x = Season, y = CaseNum, group=Category, colour=Category)) +
    geom_line() +
    geom_point() +
    labs(title = "Trend of Categories by Season", x="Season", y = "Number of Cases Filed", colour="Category") +
    theme_bw() + scale_fill_brewer(palette="Set2") + 
    theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold")) +
    scale_y_continuous(limits = c(0, 10000))

p.q21
```

```{r fig.width = 6, fig.height = 4, fig.align = "center"}

```


```{r}
res <- fsmry.by.grp(y = q2.1$CaseNum, grp = q2.1$Season)
res$summary %>% add_rownames("Season") %>% regulartable() %>% autofit() %>% align(., align = "center", part = "body")
```

```{r}
cat("\n\n\n")
res$pval.pairwise.comp %>% add_rownames("Season") %>% regulartable() %>% autofit() %>% align(., align = "center", part = "body")
```

3. Are there any trends in young children in need of help?

(data are too scarce we cannot conduct any type of statistical tests.... lm glm failed...)

```{r}
plot(x = as.yearmon(q1.D$YMD), y = q1.D$CaseNum, ylim = c(0, 50), pch = 16)
plot(x = as.yearmon(q1.SK$YMD), y = q1.SK$CaseNum, pch = 16)
```

4. Are there higher demand of support from the organization than before? Should the organization be prepared for more budget in order to support the future demands?

```{r fig.width = 6, fig.align = "center", fig.height = 10}
q4 <- dat %>% 
    dplyr::select(Date, ClientFileNum, FinSupport) %>%
    dplyr::mutate(Year = year(Date))

q4p1 <- ggplot(q4, aes(x= Year, y = ClientFileNum, group = Year)) + theme_minimal() +
    geom_bar(stat="identity") + theme_bw() + 
    labs(title = "Number of Organizations Over Time", x = "Year", y = "Number of Organizations") +
    scale_fill_brewer(palette="Set2") + 
    theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold"))

q4p2 <- ggplot(q4, aes(x= Year, y = FinSupport, group = Year)) + theme_minimal() +
    geom_bar(stat="identity") + theme_bw() + 
    labs(title = "Amount of Dollars in Financial Support Over Time", x = "Year", y = "Dollars") +
    scale_fill_brewer(palette="Set2") + 
    theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold"))

gridExtra::grid.arrange(q4p1, q4p2)
# - As the time goes by, the number of clients (organizations) are getting more and increasing.
# - The last year is 2019 and it only has data from January to August.
# - When it comes to financial support, it recorded the peak in mid 2000s. However, it is getting more and more decreasing. We could say that service/good support is increasing, while financial support is decreasing over time.
```


```{r}
dput(dat, "UMRdat")
rm(list = ls())
dget("UMRdat")
```

