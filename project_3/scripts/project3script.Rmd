---
title: "Project 3 - Statistics and Visualization"
author: "Ji-Eun Park"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
library(tidyverse)
library(RColorBrewer)
# library(knitr)
# library(scales)
```

```{r}
dat = read.csv("../data/final.csv")[,-1]
```


## Background
**Urban Ministries of Durham (UMD)** is a non-profit organization offering food, shelter and other services necessary for people in need of those aids. This project is designed to bring meaningful insights from the supply data gathered since around 1990's which is almost since the foundation of this organization (1983). 

## Project Goal
The aim of this project is to provide UMD with useful and invaluable information about the organization and the clients and provide analytic information and suggest insightful ideas for UMD.

## Data
UMD has provided 16 datasets including such as client/provider information, disability at entry/exit, health insurance at entry/exit, income at entry/exit, noncash support received entry/exit, etc. 

## Analysis Results

### 1. Demographics of UMD clients

#### i) Race and Ethnicity

```{r fig.width=5}
# Race
## Select demographical variables from data
dat1 <- dat %>% 
  select(ClientID, AgeEntry, AgeExit, Gender, Race, Ethnicity, Veteran) %>%
  unique()

# Since some clients returned couple of times, take the data from first visit
dat1 <- dat1 %>% 
  group_by(ClientID) %>%
  arrange(AgeEntry) %>%
  filter(row_number()==1)

## Generate variable vector arranged by the number of clients in each race group
table(dat1$Race) %>%
  data.frame() %>%
  arrange(Freq) %>%
  select(Var1) %>%
  as.matrix() %>% as.vector() -> vars

## Generate dataset to plot race distribution
dat1 %>%
  mutate(Race = factor(Race,levels=vars)) -> dat1.1

## Generate horizontal bar plot on race
dat1.1 %>%
  select(Race) %>%
  ggplot(aes(x=Race)) +
  geom_bar(fill="#f37735") +
  scale_y_continuous(limits=c(0,2500)) +
  coord_flip() +
  labs(title="Distribution of Clients' Race") +
  theme_bw() -> race.p

# Ethnicity
## Generate variable vector arranged by the number of clients in each ethnicity group
table(dat1$Ethnicity) %>%
  data.frame() %>%
  arrange(Freq) %>%
  select(Var1) %>%
  as.matrix() %>% as.vector() -> vars

## Generate dataset to plot ethnicity distribution
dat1 %>%
  mutate(Ethnicity = factor(Ethnicity,levels=vars)) -> dat1.2

## Generate horizontal bar plot on ethnicity
dat1.2 %>%
  select(Ethnicity) %>%
  ggplot(aes(x=Ethnicity)) +
  geom_bar(fill="#ffc425") +
  scale_y_continuous(limits=c(0,2500)) +
  coord_flip() +
  labs(title="Distribution of Clients' Ethnicity") +
  theme_bw() -> ethnicity.p

## plot the two plots in one grid
# cowplot::plot_grid(race.p, ethnicity.p, nrow=2, align="v")

ggsave("../results/plots/RacePlot.png", race.p)
ggsave("../results/plots/RacePlot.png", ethnicity.p)
```

As you can see in the plots, majority of UMD's clients are Black or  African American, or white. From ACS (American Community Survey) data collected in 2019, the racial composition of Durham is: White(47.96%), Black or African American(39.65%), Asian(5.18%), Native American (0.25%), Native Hawaiian or Pacific Islander (0.05%). Considering this fact, we can see that there is a very high ratio of Black/African American clients. 

(reference: http://worldpopulationreview.com/us-cities/durham-population/)



#### ii) Age Groups

```{r}
# Generate new variable with age groups for each client
dat1 <- dat1 %>% 
  mutate(AgeGroup = ifelse(AgeEntry<20,"10s",ifelse(AgeEntry<30,"20s",ifelse(AgeEntry<40, "30s",ifelse(AgeEntry<50, "40s",ifelse(AgeEntry<60,"50s",ifelse(AgeEntry<70, "60s",ifelse(AgeEntry<80,"70s",ifelse(AgeEntry<90,"80s","90s"))))))))) 
```

```{r fig.width=5}
# Bar plot for Age groups of clients at Entry
dat1 %>%
  select(AgeGroup) %>%
  ggplot(aes(x=AgeGroup)) +
  geom_bar(fill="maroon") +
  labs(title="Distribution of Clients' Age Groups at Entry") +
  theme_bw() -> p2

p2 

ggsave("../results/plots/AgeGroupPlot.png",p2)
```

Results show that majority of the clients are in their 20s to 50s, where 40-50s have the highest proportion. 



#### iii) Gender

```{r fig.width=5}
# generate the number of clients in each gender status
dat1 %>%
  group_by(Gender) %>%
  count(Gender) -> gendercount # count 

# generate the proportion of each gender status
gendercount$prop <- round(gendercount$n / sum(gendercount$n),3) *100

# generate the coordiate for each gender status
gendercount <- gendercount %>%
  arrange(desc(Gender)) %>%
  mutate(lab.ypos = cumsum(prop) - 0.5*prop)

# pie chart for distribution of client gender
gendercount %>%
  ggplot(aes(x=1,y=prop, fill=Gender)) +
  geom_col() +
  geom_text(aes(label=prop), position = position_stack(vjust=0.5), color="white") +
  coord_polar(theta="y") +
  scale_fill_manual(values=brewer.pal(7, "Dark2")[c(5,6,7)]) +
  labs(title="Distribution of Clients's Gender") +
  theme_void() -> p3

p3

ggsave("../results/plots/GenderPlot.png",p3)
```

You can see that the clients at UMD have 72% male clients and 28% female clients. Very minor, but there also exists some MTF clients. 



#### iv) Veteran Status

```{r fig.width=5}
# Change the levl of the Veterans so that it can be displayed as expected
dat1 %>%
  mutate(Veteran = factor(Veteran, levels=c("Yes","No","Data not collected"))) -> dat1

# generate the number of clients in each veteran status
dat1 %>%
  group_by(Veteran) %>%
  count(Veteran) -> veterancount # count 

# generate the proportion of each veteran status
veterancount$prop <- round(veterancount$n / sum(veterancount$n),3) *100

# generate the coordiate for each veteran status
veterancount <- veterancount %>%
  arrange(desc(Veteran)) %>%
  mutate(lab.ypos = cumsum(prop) - 0.5*prop)

# pie chart for distribution of client gender
veterancount %>%
  ggplot(aes(x=1,y=prop, fill=Veteran)) +
  geom_col() +
  geom_text(aes(label=prop), position = position_stack(vjust=0.5), color="white") +
  coord_polar(theta="y") +
  scale_fill_manual(values=brewer.pal(3, "Dark2")[c(1, 3,2)]) +
  labs(title="Distribution of Clients' Veteran status") +
  theme_void() -> p4

p4
ggsave("../results/plots/VeteranPlot.png",p4)
```

12.3% of the clients are veterans.




###  2. How did the income and non-cash support change from entry to exit? Were there any improvements?

```{r fig.width=5}
# select variables related to income non-cash support at entry and exit
dat %>%
  select(ClientID, IncomeEntry, IncomeExit, ReceivingBenefitEntry, ReceivingBenefitExit) %>%
  mutate(IncomeEntry = ifelse(IncomeEntry=="Yes","Yes","No"),
         IncomeExit = ifelse(IncomeExit=="Yes","Yes","No"),
         NoncashEntry = ifelse(ReceivingBenefitEntry=="Yes","Yes","No"),
         NoncashExit = ifelse(ReceivingBenefitExit=="Yes","Yes","No")) %>% # assign yes/no values
  select(ClientID, IncomeEntry, IncomeExit, NoncashEntry, NoncashExit) %>%
  unique() %>%
  mutate(EntrySource = ifelse(IncomeEntry=="Yes"|NoncashEntry=="Yes","Yes","No"),
         ExitSource = ifelse(IncomeExit=="Yes"|NoncashExit=="Yes","Yes","No")) -> dat2
# Generate a new variable that shows if they have either income or non-cash support at entry/exit

# Generate the proportion of each cell in the contingency table to generate plot
with(dat2, table(EntrySource, ExitSource)) %>% 
  data.frame() %>% 
  mutate(p = round(Freq/sum(Freq),3)) %>%
  mutate(Group = c("No-No", "Yes-No", "No-Yes", "Yes-Yes")) -> dat2.1

# Generate counts and proportions to generate mosaic plot of contingency table
dat2 %>%
  group_by(ExitSource,EntrySource) %>%
  summarise(count=n()) %>%
  mutate(cut.count=sum(count),
         prop=count/sum(count)) %>%
  ungroup() %>% 
  mutate(p = round(count/sum(count),3)) -> dat2.2

# Plot a mosaic plot to show the distribution of clients with income/non-cash support at entry/exit
(ggplot(dat2.2,
       aes(x = ExitSource, y = prop, width = cut.count, fill = EntrySource)) +
  geom_bar(stat = "identity", position = "fill", colour = "black") +
    scale_fill_manual(values=c("#f37735", "maroon")) +
  geom_label(aes(label = scales::percent(p)), position = position_stack(vjust = 0.5),show_guide  = F) + # if labels are desired
  facet_grid(~ExitSource, scales = "free_x", space = "free_x") +
  theme_minimal() +
  theme(strip.background =element_rect(fill="white"),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(), 
        axis.text.y = element_blank())+
  labs(y="", x="Source at Exit", title="Clients' with Monetary/Non-monetary source at Entry/Exit") -> p5)

ggsave("../results/plots/IncomeMosaicPlot.png",p5)
```

The above plot summarizes the ratio of clients who had monetary or non-monetary source of support at entry versus exit of the program. As we can observe, around 96% of the clients did not have change in the status, either did not have any source at entry and exit, or had a source at entry and exit. 

Only 3.6% of the clients who did not have source at entry found a source at exit. And although it is minor, 0.2% of the clients lost their existing source at exit.

```{r fig.width=5}
# Filter the clients who had improved status (No income, no non-cash support at entry, either at exit)
dat2 %>%
  filter(EntrySource=="No",ExitSource=="Yes") %>%
  select(ClientID) %>%
  as.matrix() %>%
  as.vector() -> improve

# Filter the clients who had worsened status (Either income or non-cash support at entry, none at exit)
dat2 %>%
  filter(EntrySource=="Yes",ExitSource=="No") %>%
  select(ClientID) %>%
  as.matrix() %>%
  as.vector()  -> lost

# Get demographics of clients with improved status
dat1 %>%
  filter(ClientID %in% improve) -> improve.demo

# Plot improved clients' age group
(improve.demo %>%
  select(ClientID, AgeGroup) %>%
  ggplot(., aes(x=AgeGroup)) +
  geom_bar(fill="#446455") +
  theme_bw() +
  labs(title="Age Group Distribution of Clients with Improved Support Status") -> p6)

# Get demographics of clients with worsened status
dat1 %>%
  filter(ClientID %in% lost) -> lost.demo

# Plot worsened clients' age group
(lost.demo %>%
  select(ClientID, AgeGroup) %>%
  ggplot(., aes(x=AgeGroup)) +
  geom_bar(fill="#ffc425") +
  theme_bw() +
  labs(title="Age Group Distribution of Clients with Worsened Support Status") -> p7)

ggsave("../results/plots/AgeGroupImprovedPlot.png",p6)
ggsave("../results/plots/AgeGroupWorsenPlot.png",p7)

# (p8 <- cowplot::plot_grid(p6, p7, nrow=2, align="v"))
# ggsave("../results/plots/AgeGroupImproveWorsenPlot.png",p8)
```

We can see that considering the age distribution of the clients, there is a higher chance of clients in their 20s to have better chance in improving their income status. We can guess that there are more demands for young workers.




### 3. What are the major reasons why the clients left?

```{r c}
# Choose variables of interest
dat %>%
  select(ClientID, EntryDate, ExitDate, ReasonforLeaving) %>%
  unique() %>% 
  group_by(ClientID) %>%
  arrange(ClientID, EntryDate) %>%
  filter(row_number()==n()) %>% # Find the last entry of each client
  filter(ReasonforLeaving !="")   -> dat3.1# remove data with reason for leaving values empty

# Count the number of clients for each reason for leaving
table(dat3.1$ReasonforLeaving) %>%
  data.frame() %>%
  arrange(Freq) %>%
  select(Var1) %>%
  as.matrix() %>% as.vector() -> vars

dat3.1 %>% 
  mutate(ReasonforLeaving = factor(ReasonforLeaving, levels=vars)) -> dat3.1

# Plot the distribution of the reason for leaving
(ggplot(dat3.1, aes(x=ReasonforLeaving,fill=ReasonforLeaving)) +
  geom_bar(fill="#046C9A") +
  coord_flip() +
  theme_bw() +
  labs(title="Reason for Leaving", x="Reasons") -> p9)

ggsave("../results/plots/LeavingReasonPlot.png", p9)
```

We can see that the major reason for leaving is unknown or clients disappeared. This may imply that there are some underlying problems that clients are facing and had to leave without telling UMD. There are many possibilities but one possibility is that the status of the clients did not improve while staying at UMD. It is important to look deeper into client care.

Also, many clients left due to completion of program or housing opportunities, around 200 clients (out of 2352) had to leave due to non-compliance or due to needs not met. This is also something UMD might want to look into, in order to provide more service and goods to variety of people. 

Let's look deeper on who left for each reason.

```{r}
## Agegroup 
dat1%>%group_by(AgeGroup)%>%summarise(ttlcnt = n())%>%select(ttlcnt) %>% as.matrix %>%as.vector-> ttln

### Unknown/Disappeared
disap <- dat3.1$ClientID[dat3.1$ReasonforLeaving == "Unknown/Disappeared"]

dat1 %>%
  filter(ClientID %in% disap) %>%
  group_by(AgeGroup) %>%
  summarise(count =n()) %>%
  mutate(totalcount = ttln, 
         percentage = round(count/ ttln,3)) %>%
  # knitr::kable(., format="html", caption = "Age distribution in clients reason for leaving is unknown/disappeared") %>%
  knitr::kable(., caption = "Age distribution in clients reason for leaving is unknown/disappeared") 
  # kableExtra::kable_styling(bootstrap_options = "basic", full_width = FALSE)

### Needs could not be met
unsat <- dat3.1$ClientID[dat3.1$ReasonforLeaving == "Needs could not be met"]

dat1 %>%
  filter(ClientID %in% unsat) %>%
  group_by(AgeGroup) %>%
  summarise(count =n()) %>%
  mutate(totalcount = ttln, 
         percentage = round(count/ ttln,3)) %>%
  # knitr::kable(., format="html", caption = "Age distribution in unsatisfied clients")  %>%
  knitr::kable(., caption = "Age distribution in unsatisfied clients")  
  # kableExtra::kable_styling(bootstrap_options = "basic", full_width = FALSE)

### Completed
comp <- dat3.1$ClientID[dat3.1$ReasonforLeaving == "Completed program"]
dat1 %>%
  filter(ClientID %in% comp) %>%
  group_by(AgeGroup) %>%
  summarise(count =n()) %>%
  mutate(totalcount = ttln, 
         percentage = round(count/ ttln,3)) %>%
  # knitr::kable(., format="html", caption = "Age distribution in clients complete program") %>%
    knitr::kable(., caption = "Age distribution in clients complete program") 
  # kableExtra::kable_styling(bootstrap_options = "basic", full_width = FALSE)
```

One noticeable characteristics of patients for the major reasons for leaving is that clients from 20s and 30s were more likely to disappear or leave without giving reason compared to 40s to 60s who were more likely to stay until completion of the program.

This may indicate that the UMD service is focused on elders but not youngs.


### 4. Relationship between length of stay and client demographics

```{r}
# Convert the data type of date variables
dat$EntryDate <- as.Date(as.character(dat$EntryDate), "%m/%d/%Y")
dat$ExitDate <- as.Date(as.character(dat$ExitDate), "%m/%d/%Y")

# Generate variable of length of stay (by day)
dat$lengthofstay <- dat$ExitDate-dat$EntryDate

# Select variables of interest
dat %>%
  select(ClientID, EntryDate, ExitDate, lengthofstay) %>%
  unique() %>%
  arrange(ClientID, EntryDate) -> dat4

# generate the number of visits and total length of stay (for multiple visits)
dat4 %>%
  group_by(ClientID) %>%
  summarise(visitnum = n(), ttl_lengthofstay = sum(lengthofstay)) -> dat4.1

# Left join the newly generated data
left_join(dat, dat4.1, by="ClientID") -> dat
left_join(dat4, dat4.1, by="ClientID") -> dat4

dat %>%
  select(ClientID, Gender, Race, Ethnicity, Veteran, visitnum, ttl_lengthofstay) %>%
  unique() %>%
  mutate(Race = factor(Race, levels=c("Black or African American",
                                      "White", "American Indian or Alaska Native",
                                      "Native Hawaiian or Other Pacific Islander",
                                      "Asian", "Client refused", "Data not collected",
                                      "Client doesn't know"))) -> dat4.2

left_join(dat4.2, dat1 %>% select(ClientID, AgeGroup), by="ClientID") %>%
  mutate(AgeGroup = factor(AgeGroup, levels=c("10s","20s","30s","40s","50s","60s","70s")),
         Gender = factor(Gender, levels=c("Female","Male","Trans Female (MTF or Male to Female)"))) -> dat4.2
```



#### i) Race 

```{r fig.width=10}
# Summarise by Race
kruskal.test(ttl_lengthofstay ~ Race, data = dat4.2)$p.value-> kwrace

(ggplot(dat4.2, aes(x=Race,y=ttl_lengthofstay)) +
  geom_boxplot(outlier.shape = NA, fill="maroon") +
  labs(title= "Total length of Stay by Race Groups",
       y = "Total Length of Stay") +
  coord_flip() +
  scale_x_discrete(limits = rev(levels(dat4.2$Race))) +
  annotate("text",  x=Inf, y = Inf, label = paste("p=", round(kwrace,3)) , vjust=1, hjust=1) +
  ylim(0,180) +
  theme_bw()  +
  theme(legend.position = "none")  -> p10)

ggsave("../results/plots/ttllengthofstayRacePlot.png", p10)
```

```{r fig.width=10}
# Result removing clients with race unknown
dat4.2 %>%
  filter(!Race %in% c("Client refused","Data not collected","Client doesn't know")) %>%
  mutate(Race = droplevels(Race)) -> dat4.3
kruskal.test(ttl_lengthofstay ~ Race, data = dat4.3)$p.value-> kwrace

(ggplot(dat4.3, aes(x=Race,y=ttl_lengthofstay)) +
  geom_boxplot(outlier.shape = NA, fill="maroon") +
  labs(title= "Total length of Stay by Race Groups\n(Race Info Known)",
       y = "Total Length of Stay") +
  coord_flip() +
  scale_x_discrete(limits = rev(levels(dat4.3$Race))) +
  annotate("text",  x=Inf, y = Inf, label = paste("p=", round(kwrace,3)) , vjust=1, hjust=1) +
  ylim(0,180) +
  theme_bw() +
  theme(legend.position = "none")  -> p11)

ggsave("../results/plots/ttllengthofstayRacePlot2.png", p11)
```

Above are the boxplots which shows the distribution of the total length of stay clients in each Race group. The first one is based on the entire dataset, while the second one is only based on data with Race group known. I used the Kruskal Wallis test, which is a non-parametric multigroup comparison test to see if there's significant difference in the total length of stay among race groups. However, both results does not show significant difference (p=0.267, 0.094) under the significance level 0.05.



#### ii) Age Group

```{r fig.width=5}
# Summarise by AgeGroup
kruskal.test(ttl_lengthofstay ~ AgeGroup, data = dat4.2)$p.value-> kwage

(ggplot(dat4.2, aes(x=AgeGroup,y=ttl_lengthofstay)) +
  geom_boxplot(outlier.shape = NA, fill="#f37735") +
  labs(title= "Total length of Stay by Age Groups",
       y = "Total Length of Stay") +
  coord_flip() +
  scale_x_discrete(limits = rev(levels(dat4.2$AgeGroup))) +
  annotate("text",  x=Inf, y = Inf, label = paste("p=", round(kwage,3)) , vjust=1, hjust=1) +
  ylim(0,180) +
  theme_bw() +
  theme(legend.position = "none")  -> p12)

ggsave("../results/plots/ttllengthofstayAgePlot.png", p12)


pairwise.wilcox.test(as.numeric(dat4.2$ttl_lengthofstay), dat4.2$AgeGroup, p.adjust.method = "none")$p.value %>%
  as.vector() -> pwage
round(pwage[!is.na(pwage)],2) -> pwage
data.frame(p=as.numeric(pwage),comparison=c("20s vs 10s","30s vs 10s","40s vs 10s","50s vs 10s","60s vs 10s","70s vs 10s","30s vs 20s","40s vs 20s","50s vs 20s","60s vs 20s","70s vs 20s","40s vs 30s","50s vs 30s","60s vs 30s","70s vs 30s", "50s vs 40s","60s vs 40s","70s vs 40s","60s vs 50s", "70s vs 50s","70s vs 60s")) -> pwage
```

Above are the boxplots which shows the distribution of the total length of stay clients in each Age group. Our Kruskal-Wallis test showed significant difference in total length of stay between some Age groups. Based on pairwise wilcoxon test we know that the following groups have significant difference:  `r paste(pwage[pwage$p<0.05,"comparison"], collapse = ",")`.

Hence, we can see that clients in their 20s, 30s tend to have a significantly lower total length of stay.



#### iii) Gender

```{r fig.width=10}
# Summarise by Gender
kruskal.test(ttl_lengthofstay ~ Gender, data = dat4.2)$p.value-> kwgen

(ggplot(dat4.2, aes(x=Gender,y=ttl_lengthofstay)) +
  geom_boxplot(outlier.shape = NA, fill="#ffc425") +
  labs(title= "Total length of Stay by Gender",
       y = "Total Length of Stay") +
  coord_flip() +
  scale_x_discrete(limits = rev(levels(dat4.2$Gender))) +
  annotate("text",  x=Inf, y = Inf, label = paste("p=", round(kwgen,3)) , vjust=1, hjust=1) +
  ylim(0,180) +
  theme_bw() +
  theme(legend.position = "none") -> p13)

ggsave("../results/plots/ttllengthofstayGenderPlot.png", p13)
```

Same process was done on Gender groups, but there were no significant difference between Gender groups.



#### iv) Veteran status

```{r fig.width=10}
# Summarise by Veteran status
kruskal.test(ttl_lengthofstay ~ Veteran, data = dat4.2)$p.value -> kwvet

(ggplot(dat4.2, aes(x=Veteran,y=ttl_lengthofstay)) +
  geom_boxplot(outlier.shape = NA,fill=brewer.pal(7, "Dark2")[5]) +
  labs(title= "Total length of Stay by Veteran Status",
       y = "Total Length of Stay", x = "Veteran Status") +
  coord_flip() +
  scale_x_discrete(limits = rev(levels(dat4.2$Veteran))) +
  annotate("text",  x=Inf, y = Inf, label = paste("p=", round(kwvet,3)) , vjust=1, hjust=1) +
  ylim(0,180) +
  theme_bw() +
  theme(legend.position = "none") -> p14)

ggsave("../results/plots/ttllengthofstayVeteranPlot.png", p14)
```

```{rfig.width=10}
# Result removing clients with race unknown
dat4.2 %>%
  filter(!Veteran %in% c("Data not collected")) %>%
  mutate(Veteran = droplevels(Veteran)) -> dat4.3
kruskal.test(ttl_lengthofstay ~ Veteran, data = dat4.3)$p.value-> kwvet

(ggplot(dat4.3, aes(x=Veteran,y=ttl_lengthofstay)) +
  geom_boxplot(outlier.shape = NA,fill=brewer.pal(7, "Dark2")[5]) +
  labs(title= "Total length of Stay by Veteran Status\n(Veteran status Info Known)",
       y = "Total Length of Stay", x = "Veteran status") +
  coord_flip() +
  scale_x_discrete(limits = rev(levels(dat4.3$Veteran))) +
  annotate("text",  x=Inf, y = Inf, label = paste("p=", round(kwvet,3)) , vjust=1, hjust=1) +
  ylim(0,180) +
  theme_bw() +
  theme(legend.position = "none") -> p15)

ggsave("../results/plots/ttllengthofstayVeteranPlot2.png", p15)
```

For Veteran status, the difference was checked for both 1)whole data, and 2)data without clients with unkown veteran status. Interestingly both Kruskal Wallis test results show there is significant difference in total length of stay between veteran status. Since we only have two veteran status (veteran vs not veteran), it is implied from the boxplot that veterans have lower total length of stay thn non veterans.

### 5. Relationship between client recurrence and demographics

Same process as question 4. Although we are using non-parametric methods to test significance different groups, since the values are very small, barplots will be used instead of boxplots.

#### i) Race 

```{r fig.width=10}
# Summarise by Race
kruskal.test(visitnum ~ Race, data = dat4.2)$p.value-> kwrace

(dat4.2 %>%
    group_by(Race) %>%
    summarise(meanvisit=mean(visitnum)) %>%
    ggplot(., aes(x=Race,y=meanvisit)) +
    geom_bar(stat="identity", fill="#046C9A") +
    labs(title= "Number of visits by Race Groups",
         y = "Average Number of visits") +
    coord_flip() +
    scale_x_discrete(limits = rev(levels(dat4.2$Race))) +
    annotate("text",  x=Inf, y = Inf, label = paste("p=", round(kwrace,3)) , vjust=1, hjust=1) +
    # ylim(0.7,3.5) +
    theme_bw() +
    theme(legend.position = "none") -> p16)

ggsave("../results/plots/numstayRacePlot.png", p16)
```

```{r fig.width=10}
# Result removing clients with race unknown
dat4.2 %>%
  filter(!Race %in% c("Client refused","Data not collected","Client doesn't know")) %>%
  mutate(Race = droplevels(Race)) -> dat4.3

kruskal.test(visitnum ~ Race, data = dat4.3)$p.value-> kwrace

(dat4.3 %>%
    group_by(Race) %>%
    summarise(meanvisit=mean(visitnum)) %>%
    ggplot(., aes(x=Race,y=meanvisit)) +
    geom_bar(stat="identity", fill="#046C9A") +
    labs(title= "Number of visits by Race Groups",
         y = "Average Number of visits") +
    coord_flip() +
    scale_x_discrete(limits = rev(levels(dat4.3$Race))) +
    annotate("text",  x=Inf, y = Inf, label = paste("p=", round(kwrace,3)) , vjust=1, hjust=1) +
    # ylim(0.7,3.5) +
    theme_bw() +
    theme(legend.position = "none") -> p17)
  
ggsave("../results/plots/numstayRacePlot2.png", p17)

pairwise.wilcox.test(dat4.3$visitnum, dat4.3$Race, p.adjust.method = "none")$p.value %>%
  as.vector() -> pwrace
round(pwrace[!is.na(pwrace)],2) -> pwrace
data.frame(p=as.numeric(pwrace),comparison=c("White vs Black/African American", 
                                             "American Indian/Alaska Native vs Black/African American",
                                             "Native Hawaiian/Other Pacific Islander vs Black/African American",
                                             "Asian vs Black/African American",
                                             "American Indian/Alaska Native vs White",
                                             "Native Hawaiian/Other Pacific Islander vs White",
                                             "Asian vs White",
                                             "Native Hawaiian/Other Pacific Islander vs American Indian/Alaska Native",
                                             "Asian vs American Indian/Alaska Native",
                                             "Asian vs Native Hawaiian/Other Pacific Islander")) -> pwrace
```

Same process was done with number of visits instead of total length of stay. Results show that when data with unkown race were removed, there are significant differences between some Race groups. Based on wilcoxon rank sum test, `r paste(pwrace[pwrace$p<0.05,"comparison"], collapse = ",")` have significant difference. 
Hence we can see Native Hawaiian or Other Pacific Islanders have significantly less recurrence compared to White or Black/African American clients.



#### ii) Age Group

```{r fig.width=10}
# Summarise by AgeGroup
kruskal.test(visitnum ~ AgeGroup, data = dat4.2)$p.value-> kwage

(dat4.2  %>%
    group_by(AgeGroup) %>%
    summarise(meanvisit=mean(visitnum)) %>%
    ggplot(., aes(x=AgeGroup,y=meanvisit)) +
    geom_bar(stat="identity", fill="#ffc425") +
    labs(title= "Number of visits by Age Groups",
         y = "Average Number of visits") +
    coord_flip() +
    scale_x_discrete(limits = rev(levels(dat4.2$AgeGroup))) +
    annotate("text",  x=Inf, y = Inf, label = paste("p=", round(kwage,3)) , vjust=1, hjust=1) +
    # ylim(0.7,3.5) +
    theme_bw() +
    theme(legend.position = "none") -> p18)

ggsave("../results/plots/numstayAgePlot.png", p18)

pairwise.wilcox.test(as.numeric(dat4.2$visitnum), dat4.2$AgeGroup, p.adj = "none")$p.value %>%
  as.vector() -> pwage
round(pwage[!is.na(pwage)],2) -> pwage
data.frame(p=as.numeric(pwage),comparison=c("20s vs 10s","30s vs 10s","40s vs 10s","50s vs 10s","60s vs 10s","70s vs 10s","30s vs 20s","40s vs 20s","50s vs 20s","60s vs 20s","70s vs 20s","40s vs 30s","50s vs 30s","60s vs 30s","70s vs 30s", "50s vs 40s","60s vs 40s","70s vs 40s","60s vs 50s", "70s vs 50s","70s vs 60s")) -> pwage
```

Kruskal-Wallis test showed significant difference in number of visits between some Age groups. Based on pairwise wilcoxon test we know that the following groups have significant difference:  `r paste(pwage[pwage$p<0.05,"comparison"], collapse = ",")`.

Hence, we can see that clients in their 60s and 70s tend to have a significantly lower recurrence.



#### iii) Gender

```{r fig.width=10}
# Summarise by Gender
kruskal.test(visitnum ~ Gender, data = dat4.2)$p.value-> kwgen

(dat4.2 %>%
    group_by(Gender) %>%
    summarise(meanvisit=mean(visitnum)) %>%
    ggplot(., aes(x=Gender,y=meanvisit)) +
    geom_bar(stat="identity", fill="#7570B3") +
    labs(title= "Number of visits by Gender Groups",
         y = "Average Number of visits") +
    coord_flip() +
    scale_x_discrete(limits = rev(levels(dat4.2$Gender))) +
    annotate("text",  x=Inf, y = Inf, label = paste("p=", round(kwgen,3)) , vjust=1, hjust=1) +
    # ylim(0.7,3.5) +
    theme_bw() +
    theme(legend.position = "none") -> p19)

ggsave("../results/plots/numstayGenderPlot.png", p19)

pairwise.wilcox.test(as.numeric(dat4.2$visitnum), dat4.2$Gender, p.adj = "none")$p.value %>%
  as.vector() -> pwgender
round(pwgender[!is.na(pwgender)],2) -> pwgender
data.frame(p=as.numeric(pwgender),comparison=c("Male vs Female", "Trans Female vs Female", "Trans Female vs Male")) -> pwgender

```

Same process was done on Gender groups, and results show that there are significant differences between some Gender groups. Based on wilcoxon rank sum test, `r paste(pwgender[pwgender$p<0.05,"comparison"], collapse = ",")` have significant difference. To be specific, male clients have longer stay than female clients.


#### iv) Veteran status

```{r fig.width=10}
# Summarise by Veteran status
kruskal.test(visitnum ~ Veteran, data = dat4.2)$p.value -> kwvet

(dat4.2 %>%
    group_by(Veteran) %>%
    summarise(meanvisit=mean(visitnum)) %>%
    ggplot(., aes(x=Veteran,y=meanvisit)) +
    geom_bar(stat="identity", fill="#f37735") +
    labs(title= "Number of visits by Veteran Statuss",
         y = "Average Number of visits") +
    coord_flip() +
    scale_x_discrete(limits = rev(levels(dat4.2$Veteran))) +
    annotate("text",  x=Inf, y = Inf, label = paste("p=", round(kwvet,3)) , vjust=1, hjust=1) +
    # ylim(0.7,3.5) +
    theme_bw() +
    theme(legend.position = "none")  -> p20)

ggsave("../results/plots/numstayVeteranPlot.png", p20)
```

```{r fig.width=10}
# Result removing clients with race unknown
dat4.2 %>%
  filter(!Veteran %in% c("Data not collected")) %>%
  mutate(Veteran = droplevels(Veteran)) -> dat4.3
kruskal.test(visitnum ~ Veteran, data = dat4.3)$p.value-> kwvet

(dat4.3 %>%
    group_by(Veteran) %>%
    summarise(meanvisit=mean(visitnum)) %>%
    ggplot(., aes(x=Veteran,y=meanvisit)) +
    geom_bar(stat="identity", fill="#f37735") +
    labs(title= "Number of visits by Veteran Statuss",
         y = "Average Number of visits") +
    coord_flip() +
    scale_x_discrete(limits = rev(levels(dat4.3$Veteran))) +
    annotate("text",  x=Inf, y = Inf, label = paste("p=", round(kwvet,3)) , vjust=1, hjust=1) +
    # ylim(0.7,3.5) +
    theme_bw() +
    theme(legend.position = "none") -> p21)

ggsave("../results/plots/numstayVeteranPlot2.png", p21)

```

For Veteran status, the difference was checked for both 1)whole data, and 2)data without clients with unkown veteran status. Since we only have two veteran status (veteran vs not veteran), it is implied from the boxplot that veterans have lower recurrence than non veterans.

## Conclusion

- UMD’s service is focused on clients in elders (especially 40s-50s), mostly composed with Black/African American, Male clients.


- Clients in their 20s seem to have better chance of improving their income or non-cash support status while at UMD, which is quite reasonable as the job market prefer young workers.

- Not surprisingly, clients in 20-30s also have shorter length of stay, and elder clients have longer length of stay and tend to revisit UMD more than younger clients.

- Nonetheless, satisfaction of UMD’s service seems to be higher in elders (40s-60s)

- However, UMD should not neglect developing service suitable for young clients. Otherwise, UMD can focus on clients from 40s, and transfer young clients to shelters that focus more on them.



